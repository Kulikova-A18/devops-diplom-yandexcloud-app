name: CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  REGISTRY: cr.yandex/crps1p5u048a00f4o97j
  IMAGE_NAME: testapp
  K8S_NAMESPACE: app
  DEPLOYMENT_NAME: testapp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Yandex CR
      run: |
        echo '${{ secrets.YC_SA_KEY }}' | docker login --username json_key --password-stdin cr.yandex

    - name: Build and push
      run: |
        TAG=${GITHUB_SHA::8}
        docker build -t $REGISTRY/$IMAGE_NAME:$TAG .
        docker push $REGISTRY/$IMAGE_NAME:$TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Deploy to cluster
      env:
        K8S_CONFIG: ${{ secrets.K8S_CONFIG }}
      run: |
        # Создаем kubeconfig из секрета
        echo "$K8S_CONFIG" > kubeconfig.yaml
        
        # Деплоим
        kubectl --kubeconfig=kubeconfig.yaml set image deployment/$DEPLOYMENT_NAME $DEPLOYMENT_NAME=$REGISTRY/$IMAGE_NAME:${GITHUB_SHA::8} -n $K8S_NAMESPACE
        kubectl --kubeconfig=kubeconfig.yaml rollout status deployment/$DEPLOYMENT_NAME -n $K8S_NAMESPACE --timeout=300s
