name: Simple CI/CD

on:
  push:
    branches: [main]

env:
  REGISTRY: cr.yandex/crps1p5u048a00f4o97j
  IMAGE_NAME: testapp
  K8S_NAMESPACE: app
  DEPLOYMENT_NAME: testapp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Yandex CR
      run: |
        echo '${{ secrets.YC_SA_KEY }}' | docker login --username json_key --password-stdin cr.yandex

    - name: Build and push
      run: |
        TAG=${GITHUB_SHA::8}
        docker build -t $REGISTRY/$IMAGE_NAME:$TAG .
        docker push $REGISTRY/$IMAGE_NAME:$TAG
        docker tag $REGISTRY/$IMAGE_NAME:$TAG $REGISTRY/$IMAGE_NAME:latest
        docker push $REGISTRY/$IMAGE_NAME:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Get internal endpoint
      run: |
        # Получаем внутренний IP ноды для подключения
        echo "Внешний endpoint недоступен, используем прямое подключение к нодам"
        echo "Доступные ноды:"
        echo "89.169.152.21"
        echo "84.201.152.99" 
        echo "158.160.197.70"

    - name: Deploy via SSH (альтернатива)
      run: |
        echo "Так как прямой доступ к API серверу недоступен, нужно:"
        echo "1. Настроить VPN/SSH туннель к кластеру"
        echo "2. Использовать self-hosted runner внутри VPC"
        echo "3. Настроить доступ через bastion host"
