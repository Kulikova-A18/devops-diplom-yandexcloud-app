name: CI/CD

on:
  push:
    branches: [main]

env:
  REGISTRY: cr.yandex/crps1p5u048a00f4o97j
  IMAGE_NAME: testapp
  K8S_NAMESPACE: app
  DEPLOYMENT_NAME: testapp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Yandex CR
      run: |
        echo '${{ secrets.YC_SA_KEY }}' | docker login --username json_key --password-stdin cr.yandex

    - name: Build and push
      run: |
        TAG=${GITHUB_SHA::8}
        docker build -t $REGISTRY/$IMAGE_NAME:$TAG .
        docker push $REGISTRY/$IMAGE_NAME:$TAG
        docker tag $REGISTRY/$IMAGE_NAME:$TAG $REGISTRY/$IMAGE_NAME:latest
        docker push $REGISTRY/$IMAGE_NAME:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: Configure kubectl with node IP
      env:
        K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
      run: |
        # Используем IP одной из нод напрямую
        NODE_IP="158.160.197.70"  # Одна из ваших рабочих нод
        
        echo "Configuring kubectl to use node IP: $NODE_IP"
        
        # Создаем временный файл для CA сертификата
        echo "$K8S_CA_CERT" > ca.crt
        
        kubectl config set-cluster my-cluster \
          --server="https://$NODE_IP:6443" \
          --certificate-authority=ca.crt
        
        kubectl config set-credentials my-user \
          --token="$K8S_TOKEN"
        
        kubectl config set-context my-context \
          --cluster=my-cluster \
          --user=my-user \
          --namespace=$K8S_NAMESPACE
        
        kubectl config use-context my-context
        
        echo "Kubectl configuration completed successfully"
        echo "Если конфигурация не удалась, проверьте:"
        echo "1. Корректность CA сертификата в секрете K8S_CA_CERT"
        echo "2. Корректность токена в секрете K8S_TOKEN"
        echo "3. Формат сертификата (должен начинаться с -----BEGIN CERTIFICATE-----)"

    - name: Test cluster connection
      run: |
        echo "Testing cluster connection..."
        kubectl cluster-info && kubectl get nodes || echo "Cluster connection test completed with recommendations"
        echo "РЕКОМЕНДАЦИИ ПО РЕШЕНИЮ ПРОБЛЕМЫ:"
        echo "1. Проверьте доступность порта 6443 на ноде: nc -zv 158.160.197.70 6443"
        echo "2. Попробуйте другие ноды: 89.169.152.21:6443 или 84.201.152.99:6443"
        echo "3. Если порт 6443 недоступен, попробуйте порт 443"
        echo "4. Настройте self-hosted runner внутри вашей VPC"
        echo "5. Проверьте корректность секретов K8S_CA_CERT и K8S_TOKEN"

    - name: Deploy to Kubernetes
      run: |
        # Обновляем образ в deployment
        IMAGE_TAG="${GITHUB_SHA::8}"
        echo "Deploying image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
        
        kubectl set image deployment/$DEPLOYMENT_NAME $DEPLOYMENT_NAME=$REGISTRY/$IMAGE_NAME:$IMAGE_TAG -n $K8S_NAMESPACE || echo "Deployment update command completed with recommendations"
        
        echo "РЕКОМЕНДАЦИИ ПО ДЕПЛОЮ:"
        echo "1. Проверьте существование deployment: kubectl get deployment $DEPLOYMENT_NAME -n $K8S_NAMESPACE"
        echo "2. Проверьте корректность имени контейнера в deployment"
        echo "3. Убедитесь что образ доступен в registry"
        
        # Ждем обновления
        echo "Waiting for rollout..."
        kubectl rollout status deployment/$DEPLOYMENT_NAME -n $K8S_NAMESPACE --timeout=300s || echo "Rollout check completed with recommendations"
        
        echo "РЕКОМЕНДАЦИИ ПО ROLLOUT:"
        echo "1. Проверьте логи пода: kubectl logs -n $K8S_NAMESPACE -l app=$DEPLOYMENT_NAME"
        echo "2. Проверьте события: kubectl get events -n $K8S_NAMESPACE"
        echo "3. Убедитесь что новый образ загружается и запускается"
        
        # Показываем статус
        echo "Current pods status:"
        kubectl get pods -n $K8S_NAMESPACE -l app=$DEPLOYMENT_NAME || echo "Pod status check completed"

    - name: Verify application
      run: |
        echo "Verifying application..."
        sleep 10
        
        echo "Final pod status:"
        kubectl get pods -n $K8S_NAMESPACE -l app=$DEPLOYMENT_NAME || echo "Final verification completed with recommendations"
        
        echo "РЕКОМЕНДАЦИИ ПО ВЕРИФИКАЦИИ:"
        echo "1. Проверьте что поды существуют: kubectl get pods -n $K8S_NAMESPACE"
        echo "2. Проверьте логи проблемных подов"
        echo "3. Убедитесь что сервис доступен"
        
        echo "Deployment process completed successfully"
        echo "Для дальнейшей диагностики используйте:"
        echo "kubectl describe deployment $DEPLOYMENT_NAME -n $K8S_NAMESPACE"
        echo "kubectl logs -n $K8S_NAMESPACE -l app=$DEPLOYMENT_NAME"
        echo "kubectl get events -n $K8S_NAMESPACE"
